@model quangcao.Models.SanPham
@{
    var categories = ViewBag.ExistingCategories as List<string> ?? new List<string>();
    ViewData["Title"] = "Thêm sản phẩm mới";
}

<div class="create-product-page">
    <div class="page-header">
        <h2><i class="fas fa-plus-circle"></i> Thêm sản phẩm mới</h2>
        <p class="text-muted">Điền đầy đủ thông tin để tạo sản phẩm mới</p>
    </div>

    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong><i class="fas fa-exclamation-triangle"></i> Có lỗi xảy ra:</strong>
            <ul class="mt-2 mb-0">
                @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                {
                    <li>@error.ErrorMessage</li>
                }
            </ul>
            <span class="text-warning">Nếu bạn đã chọn ảnh, vui lòng chọn lại ảnh sau khi sửa lỗi!</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <form asp-action="Create" enctype="multipart/form-data" method="post" class="create-product-form">
        <div class="row">
            <div class="col-md-8">
                <div class="form-card">
                    <h3 class="form-card-title">Thông tin cơ bản</h3>
                    
                    <div class="form-group">
                        <label asp-for="TenSanPham">Tên sản phẩm <span class="text-danger">*</span></label>
                        <input asp-for="TenSanPham" class="form-control" placeholder="Nhập tên sản phẩm..." />
                        <span asp-validation-for="TenSanPham" class="text-danger"></span>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="Gia">Giá <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input asp-for="Gia" class="form-control" placeholder="Nhập giá..." />
                                    <span class="input-group-text">VNĐ</span>
                                </div>
                                <span asp-validation-for="Gia" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="SoLuongDaBan">Số lượng đã bán</label>
                                <input asp-for="SoLuongDaBan" class="form-control" placeholder="0" />
                                <span asp-validation-for="SoLuongDaBan" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label asp-for="MoTa">Mô tả ngắn <span class="text-danger">*</span></label>
                        <textarea asp-for="MoTa" class="form-control" placeholder="Nhập mô tả ngắn gọn về sản phẩm..."></textarea>
                        <span asp-validation-for="MoTa" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="ChiTiet">Chi tiết sản phẩm <span class="text-danger">*</span></label>
                        <textarea asp-for="ChiTiet" class="form-control" rows="5" placeholder="Nhập thông tin chi tiết về sản phẩm..."></textarea>
                        <span asp-validation-for="ChiTiet" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-card">
                    <h3 class="form-card-title">Phân loại & Hình ảnh</h3>
                    
                    <div class="form-group">
                        <label for="TheLoai">Thể loại <span class="text-danger">*</span></label>
                        <select id="TheLoai" name="TheLoai" class="form-select" onchange="toggleNewCategoryInput(this)">
                            <option value="">-- Chọn thể loại --</option>
                            @foreach (var category in categories)
                            {
                                <option value="@category" selected="@(category == Model?.TheLoai ? "selected" : null)">@category</option>
                            }
                            <option value="Thêm thể loại mới">+ Thêm thể loại mới</option>
                        </select>
                        <span asp-validation-for="TheLoai" class="text-danger"></span>
                    </div>

                    <div class="form-group" id="NewCategoryInput" style="display:none;">
                        <label for="NewCategory">Thể loại mới <span class="text-danger">*</span></label>
                        <input type="text" name="NewCategory" id="NewCategory" class="form-control" placeholder="Nhập tên thể loại mới..." />
                        <span class="text-danger">@ViewData.ModelState["NewCategory"]?.Errors.FirstOrDefault()?.ErrorMessage</span>
                    </div>

                    <div class="form-group">
                        <label>Hình ảnh sản phẩm <span class="text-danger">*</span></label>
                        <div class="image-upload-zone" onclick="document.getElementById('imageInput').click()">
                            <input type="file" id="imageInput" name="hinhAnhFiles" class="d-none" multiple accept="image/*,video/*" onchange="previewImages(event)" />
                            <div class="upload-placeholder">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Kéo thả hoặc click để chọn ảnh</p>
                                <span class="text-muted">Hỗ trợ: JPG, PNG, GIF, MP4, WebM</span>
                            </div>
                        </div>
                        <div id="imagePreviewContainer" class="image-preview-container mt-3 row g-2"></div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary w-100 mb-2">
                        <i class="fas fa-save"></i> Tạo sản phẩm
                    </button>
                    <a href="@Url.Action("Index")" class="btn btn-light w-100">
                        <i class="fas fa-arrow-left"></i> Quay lại
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

@section Styles {
    <style>
        .create-product-page {
            padding: 2rem 0;
        }

        .page-header {
            margin-bottom: 2rem;
            text-align: center;
        }

        .page-header h2 {
            color: #2563eb;
            margin-bottom: 0.5rem;
        }

        .form-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #334155;
        }

        .form-control, .form-select {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }

        .image-upload-zone {
            border: 2px dashed #e2e8f0;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-upload-zone:hover {
            border-color: #2563eb;
            background: rgba(37,99,235,0.02);
        }

        .upload-placeholder i {
            font-size: 2rem;
            color: #94a3b8;
            margin-bottom: 1rem;
        }

        .upload-placeholder p {
            margin-bottom: 0.5rem;
            color: #64748b;
        }

        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .image-preview {
            width: 80px;
            height: 80px;
            aspect-ratio: 1;
            border-radius: 0.5rem;
            overflow: hidden;
            position: relative;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview .remove-image {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-preview .remove-image:hover {
            background: rgba(239,68,68,0.9);
        }

        .form-actions {
            position: sticky;
            bottom: 1rem;
            background: white;
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #2563eb;
            border: none;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .btn-light {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            color: #64748b;
        }

        .btn-light:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        media (max-width: 768px) {
            .create-product-page {
                padding: 1rem 0;
            }

            .form-card {
                padding: 1rem;
            }

            .image-preview {
                width: calc(50% - 0.5rem);
            }
        }
    </style>
}

@section Scripts {
    <script src="https://cdn.tiny.cloud/1/2o2esmawdbgvtbo8fgavb4c02le2h8d7p9cm0ilv0jwvm0ay/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>

    <script>
        // TinyMCE Editor
        tinymce.init({
            selector: 'textarea[name="MoTa"], textarea[name="ChiTiet"]',
            plugins: [
                'anchor', 'autolink', 'charmap', 'codesample', 'emoticons', 'image', 'link', 'lists',
                'media', 'searchreplace', 'table', 'visualblocks', 'wordcount', 'checklist', 'mediaembed',
                'casechange', 'formatpainter', 'pageembed', 'permanentpen', 'powerpaste', 'advtable',
                'advcode', 'editimage', 'tableofcontents', 'footnotes', 'mergetags', 'autocorrect'
            ],
            toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table mergetags | align lineheight | checklist numlist bullist indent outdent | emoticons charmap | removeformat',
            height: 400,
            skin: 'oxide',
            content_css: 'default',
            branding: false,
            promotion: false,
            file_picker_types: 'image',
            file_picker_callback: function (callback, value, meta) {
                if (meta.filetype === 'image') {
                    var input = document.createElement('input');
                    input.setAttribute('type', 'file');
                    input.setAttribute('accept', 'image/*');

                    input.onchange = function () {
                        var file = this.files[0];
                        var reader = new FileReader();

                        reader.onload = function () {
                            callback(reader.result, {
                                alt: file.name
                            });
                        };

                        reader.readAsDataURL(file);
                    };

                    input.click();
                }
            }
        });

        // Toggle New Category Input
        function toggleNewCategoryInput(selectElement) {
            var inputField = document.getElementById("NewCategoryInput");
            if (selectElement.value === "Thêm thể loại mới") {
                inputField.style.display = "block";
            } else {
                inputField.style.display = "none";
            }
        }

        // Image Preview
        function previewImages(event) {
            const container = document.getElementById('imagePreviewContainer');
            container.innerHTML = '';
            Array.from(event.target.files).forEach((file, index) => {
                const preview = document.createElement('div');
                preview.className = 'image-preview';
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.innerHTML = `
                            <img src="${e.target.result}" alt="Preview ${index + 1}">
                            <button type="button" class="remove-image" onclick="removeImage(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                    };
                    reader.readAsDataURL(file);
                } else if (file.type.startsWith('video/')) {
                    const url = URL.createObjectURL(file);
                    preview.innerHTML = `
                        <video src="${url}" controls style="width:100%;height:100%;object-fit:cover;"></video>
                        <button type="button" class="remove-image" onclick="removeImage(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                }
                container.appendChild(preview);
            });
        }

        // Remove Image
        function removeImage(index) {
            const input = document.getElementById('imageInput');
            const container = document.getElementById('imagePreviewContainer');
            
            const dt = new DataTransfer();
            const { files } = input;
            
            for (let i = 0; i < files.length; i++) {
                if (i !== index) {
                    dt.items.add(files[i]);
                }
            }
            
            input.files = dt.files;
            container.children[index].remove();
        }

        // Drag and Drop
        const dropZone = document.querySelector('.image-upload-zone');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropZone.classList.add('border-primary');
        }

        function unhighlight(e) {
            dropZone.classList.remove('border-primary');
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            const fileInput = document.getElementById('imageInput');
            
            fileInput.files = files;
            previewImages({ target: fileInput });
        }
    </script>
}